## 分布式存储算法

### 哈希取余分区

假设有N台机器构成一个集群

算法：Hash(key) % N

优点：简单粗暴，直接有效，只需要预估好数据、规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求并维护这些请求的信息，起到了负载均衡+分而治之的作用。

缺点：原来规划好的节点，进行扩容或者缩容就比较麻烦。如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：Hash(key)/N会变成Hash(key)/?。由于台数数量发生变化，会导致Hash取余解决发生变化，根据公式获取的服务器也会变得不可控。

### 一致性哈希算法分区

#### 1. 算法构建一致性哈希环

一致性华西算法必然有个Hash函数并按照算法产生hash值，这个算法的所有可能hash值会构成一个全量集，这个集合可以成为一个hash空间[0, 2^32-1]，这是一个线性空间，但是在算法中，我们通过适当的逻辑控制将它首位相连(0=2^32)，这样让它在逻辑上形成一个环行空间。

它也是按照使用模取余的方法，哈希取余分区算法是对节点的数量进行取模，而一致性Hash算法是对2^32取模，简单来说一致性Hash算法将整个哈希空间组织成一个虚拟的圆环。

#### 2. 服务器IP节点映射

将集群中各个IP节点映射到环的某个位置。

将各个服务器使用Hash算法，具体可以选择服务器的IP或主机名作为关键字进行Hash，这样每台机器就能确定其在哈希环的位置。

#### 3. 落键规则

当我们需要存储一个K-V键值对时，首先计算key的hash值，将这个key使用想用的函数Hash计算出hash值并确定此数据在环上的位置，从此位置沿环顺时间“行走”，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上。

![image-20230220104857368](https://image-bed-693a.obs.cn-north-4.myhuaweicloud.com/imgbed/image-20230220104857368.png)

#### 4. 优点和缺点

优点：

+ 容错性：假设Node C宕机，可以看到此时对象A、B、D不会受到影响，只有C对象被重定位到Node D。一般的，在一致性Hash算法中，如果一台服务器不可用，则受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间数据，其它不会受到影响。简单说，就是C挂了，受到影响的只是B、C之间的数据，并且这些数据会转移到D进行存储。

+ 扩展性：数据量增加了，需要增加一台节点NodeX。X的位置在A和B之间，那受到影响的也就是A到X之间的数据，重新把A到X的数据录入到X上即可，不会导致Hash取余全部数据重新洗牌。

    ![image-20230220104824351](https://image-bed-693a.obs.cn-north-4.myhuaweicloud.com/imgbed/image-20230220104824351.png)

缺点：

+ 数据倾斜：一致性Hash算法在服务节点太少时，容易因为节点分布不均匀而造成数据倾斜（被缓存的对象大部分集中缓存在某一台服务器上）问题，

    例如系统中只有两台服务器：

    ![image-20230220105003142](https://image-bed-693a.obs.cn-north-4.myhuaweicloud.com/imgbed/image-20230220105003142.png)

### 哈希槽分区

哈希槽实质上就是一个数组，数组[0, 2^14-1]形成哈希槽空间；它是为了解决均匀分配的问题，在数据和节点之间又加入了一层，把这层称为哈希槽(slot)，用于管理数据和节点之间的关系，现在就相当于节点上放的是槽，槽里放的是数据。

槽解决的是粒度问题，相当于把粒度变大，这样便于数据移动。哈希解决的是映射问题，使用key的哈希值来计算所在槽，便于数据分配。

一个集群只能有16384个槽，编号为0-16383(2^14-1)。这些槽会分配给集群中的所有主节点，分配策略没有要求。可以指定哪些编号的槽分配给哪个主节点。集群会记录节点和槽的对应关系。

解决了节点和槽的关系后，接下来就需要对key求哈希值，然后对16384取余，余数是几，key就落入对应的槽里。slot=CRC16(key)%16384。

以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。

哈希槽计算：Redis集群中内置了16384个哈希槽，Redis会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在Redis集群中放置一个K-V时，Redis先对key使用CRC16算法算出一个结果，然后把结果对16384取余，这样每个key都会对应一个编号在0-16383之间的哈希槽，也就是映射到某个节点上。
